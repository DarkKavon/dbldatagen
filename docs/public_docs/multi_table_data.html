<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generating and Using Data with Multiple Tables &mdash; Databricks Labs Data Generator 0.3.4post2 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/tdg.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Extending Text Generation" href="extending_text_generation.html" />
    <link rel="prev" title="Generating Change Data Capture Data" href="generating_cdc_data.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Databricks Labs Data Generator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="APIDOCS.html">Get Started Here</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation_notes.html">Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="generating_column_data.html">Generating column data</a></li>
<li class="toctree-l1"><a class="reference internal" href="DATARANGES.html">Using data ranges</a></li>
<li class="toctree-l1"><a class="reference internal" href="textdata.html">Generating text data</a></li>
<li class="toctree-l1"><a class="reference internal" href="DISTRIBUTIONS.html">Using data distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="options_and_features.html">Options for column specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="repeatable_data_generation.html">Repeatable Data Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="repeatable_data_generation.html#revisiting-the-iot-data-example">Revisiting the IOT data example</a></li>
<li class="toctree-l1"><a class="reference internal" href="using_streaming_data.html">Using streaming data</a></li>
<li class="toctree-l1"><a class="reference internal" href="generating_json_data.html">Generating JSON and structured column data</a></li>
<li class="toctree-l1"><a class="reference internal" href="generating_from_existing_data.html">Generating synthetic data from existing data</a></li>
<li class="toctree-l1"><a class="reference internal" href="generating_cdc_data.html">Generating Change Data Capture (CDC) data</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Using multiple tables</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#telephony-billing-example">Telephony billing example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#some-utility-functions">Some utility functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#let-s-model-our-calling-plans">Let’s model our calling plans</a></li>
<li class="toctree-l3"><a class="reference internal" href="#let-s-model-our-customers">Let’s model our customers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#now-let-s-model-our-device-events">Now let’s model our device events</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#now-let-s-compute-the-invoices">Now let’s compute the invoices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="extending_text_generation.html">Extending text generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="using_delta_live_tables.html">Use with Delta Live Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting data generation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="relnotes/quickindex.html">Quick API index</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference/api/modules.html">The dbldatagen package API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="relnotes/CONTRIBUTING.html">Contributing to the Databricks Labs Data Generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="relnotes/CONTRIBUTING.html#building-the-code">Building the code</a></li>
<li class="toctree-l1"><a class="reference internal" href="relnotes/CONTRIBUTING.html#testing">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="relnotes/CONTRIBUTING.html#using-the-databricks-labs-data-generator">Using the Databricks Labs data generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="relnotes/CONTRIBUTING.html#coding-style">Coding Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="relnotes/CHANGELOG.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="relnotes/requirements.html">Build requirements</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">License</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Databricks Labs Data Generator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Generating and Using Data with Multiple Tables</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/multi_table_data.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="generating-and-using-data-with-multiple-tables">
<h1>Generating and Using Data with Multiple Tables<a class="headerlink" href="#generating-and-using-data-with-multiple-tables" title="Permalink to this heading"></a></h1>
<p>See the section repeatable data generation for the concepts that underpin the data generation.</p>
<p>One common scenario is the need to be able to generate multiple tables
with consistent primary and foreign keys to model join or merge scenarios.</p>
<p>By generating tables with repeatable data, we can generate multiple versions of the same data for different tables and
ensure that we have referential integrity across the tables.</p>
<section id="telephony-billing-example">
<h2>Telephony billing example<a class="headerlink" href="#telephony-billing-example" title="Permalink to this heading"></a></h2>
<p>To illustrate multi-table data generation and use, we’ll use a simplified version of telecoms billing processes.</p>
<p>Let’s assume we have data as follows:</p>
<ul class="simple">
<li><p>A set of customers</p></li>
<li><dl class="simple">
<dt>A set of customer device activity events</dt><dd><ul>
<li><p>Text message</p></li>
<li><p>Local call</p></li>
<li><p>International call</p></li>
<li><p>Long distance call</p></li>
<li><p>Internet activity</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>A set of pricing plans indicating;</dt><dd><ul>
<li><p>Cost per MB of internet activity</p></li>
<li><p>Cost per minute of call for each of the call categories</p></li>
<li><p>Cost per message</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Pricing</dt><dd><ul>
<li><p>Internet activity will be priced per MB transferred.</p></li>
<li><p>Phone calls will be priced per minute or partial minute .</p></li>
<li><p>Messages will be priced per actual counts.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For simplicity, we’ll ignore the free data, messages and calls threshold in most plans and the complexity of
matching devices to customers and telecoms operators - our goal here is to show generation of join ready data,
rather than full modelling of phone usage invoicing.</p>
<p>Nothing in the example is meant to represent real world phone, internet or SMS pricing.</p>
</div>
<section id="some-utility-functions">
<h3>Some utility functions<a class="headerlink" href="#some-utility-functions" title="Permalink to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="n">MARGIN_PATTERN</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*\|&quot;</span><span class="p">)</span>  <span class="c1"># margin detection pattern for stripMargin</span>
<span class="k">def</span> <span class="nf">stripMargin</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;  strip margin removes leading space in multi line string before &#39;|&#39; &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">MARGIN_PATTERN</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="let-s-model-our-calling-plans">
<h3>Let’s model our calling plans<a class="headerlink" href="#let-s-model-our-calling-plans" title="Permalink to this heading"></a></h3>
<p>Note, we use two columns, <code class="docutils literal notranslate"><span class="pre">ld_multipler</span></code> and <code class="docutils literal notranslate"><span class="pre">intl_multiplier</span></code> just as intermediate results used
in later calculations and omit them from the output.</p>
<p>We use <code class="docutils literal notranslate"><span class="pre">decimal</span></code> types for prices to avoid rounding issues.</p>
<p>Here we use a simple sequence for our plan ids.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dbldatagen</span> <span class="k">as</span> <span class="nn">dg</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>

<span class="c1"># clear cache so that if we run multiple times to check performance,</span>
<span class="c1"># we&#39;re not relying on cache</span>
<span class="n">spark</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">clearCache</span><span class="p">()</span>

<span class="n">UNIQUE_PLANS</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">PLAN_MIN_VALUE</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">shuffle_partitions_requested</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">partitions_requested</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">data_rows</span> <span class="o">=</span> <span class="n">UNIQUE_PLANS</span> <span class="c1"># we&#39;ll generate one row for each plan</span>

<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.shuffle.partitions&quot;</span><span class="p">,</span> <span class="n">shuffle_partitions_requested</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.execution.arrow.pyspark.enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.execution.arrow.maxRecordsPerBatch&quot;</span><span class="p">,</span> <span class="mi">20000</span><span class="p">)</span>


<span class="n">plan_dataspec</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">dg</span><span class="o">.</span><span class="n">DataGenerator</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">data_rows</span><span class="p">,</span> <span class="n">partitions</span><span class="o">=</span><span class="n">partitions_requested</span><span class="p">)</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;plan_id&quot;</span><span class="p">,</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">minValue</span><span class="o">=</span><span class="n">PLAN_MIN_VALUE</span><span class="p">,</span> <span class="n">uniqueValues</span><span class="o">=</span><span class="n">UNIQUE_PLANS</span><span class="p">)</span>
    <span class="c1"># use plan_id as root value</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;plan_name&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="n">baseColumn</span><span class="o">=</span><span class="s2">&quot;plan_id&quot;</span><span class="p">)</span>

    <span class="c1"># note default step is 1 so you must specify a step for small number ranges,</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;cost_per_mb&quot;</span><span class="p">,</span> <span class="s2">&quot;decimal(5,3)&quot;</span><span class="p">,</span> <span class="n">minValue</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">maxValue</span><span class="o">=</span><span class="mf">0.050</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;cost_per_message&quot;</span><span class="p">,</span> <span class="s2">&quot;decimal(5,3)&quot;</span><span class="p">,</span> <span class="n">minValue</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">maxValue</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;cost_per_minute&quot;</span><span class="p">,</span> <span class="s2">&quot;decimal(5,3)&quot;</span><span class="p">,</span> <span class="n">minValue</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">maxValue</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># we&#39;re modelling long distance and international prices simplistically -</span>
    <span class="c1"># each is a multiplier thats applied to base rate</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;ld_multiplier&quot;</span><span class="p">,</span> <span class="s2">&quot;decimal(5,3)&quot;</span><span class="p">,</span> <span class="n">minValue</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">maxValue</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">omit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;ld_cost_per_minute&quot;</span><span class="p">,</span> <span class="s2">&quot;decimal(5,3)&quot;</span><span class="p">,</span>
                <span class="n">expr</span><span class="o">=</span><span class="s2">&quot;cost_per_minute * ld_multiplier&quot;</span><span class="p">,</span>
                <span class="n">baseColumns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cost_per_minute&#39;</span><span class="p">,</span> <span class="s1">&#39;ld_multiplier&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;intl_multiplier&quot;</span><span class="p">,</span> <span class="s2">&quot;decimal(5,3)&quot;</span><span class="p">,</span> <span class="n">minValue</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">maxValue</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">distribution</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">omit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;intl_cost_per_minute&quot;</span><span class="p">,</span> <span class="s2">&quot;decimal(5,3)&quot;</span><span class="p">,</span>
                <span class="n">expr</span><span class="o">=</span><span class="s2">&quot;cost_per_minute * intl_multiplier&quot;</span><span class="p">,</span>
                <span class="n">baseColumns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cost_per_minute&#39;</span><span class="p">,</span> <span class="s1">&#39;intl_multiplier&#39;</span><span class="p">])</span>
            <span class="p">)</span>

<span class="n">df_plans</span> <span class="o">=</span> <span class="n">plan_dataspec</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>

<span class="n">display</span><span class="p">(</span><span class="n">df_plans</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="let-s-model-our-customers">
<h3>Let’s model our customers<a class="headerlink" href="#let-s-model-our-customers" title="Permalink to this heading"></a></h3>
<p>We’ll use device id as the foreign key for device events here.</p>
<p>We want to ensure that our device id is unique for each customer. We could use a simple sequence as
with plans but for the purposes of illustration, we’ll use a hash of the customer ids instead.</p>
<p>There’s still a small likelihood of hash collisions so we’ll remove any duplicates from the generated data -
but in practice, we do not see duplicates in most small datasets when using hashing. As all data produced by
the framework is repeatable when not using random , or when using random with a seed,
this will give us a predictable range of foreign keys.</p>
<p>Use of hashes and sequences is a very efficient way of generating unique predictable keys
while introducing some pseudo-randomness in the values.</p>
<p>Note - for real telephony systems, there’s a complex set of rules around device ids (IMEI and related device ids),
subscriber numbers and techniques for matching devices to subscribers. Again, our goal here is to illustrate
generating predictable join keys not full modelling of a telephony system.</p>
<p>We use decimal types for ids to avoid exceeding the range of ints and longs when working
with a larger numbers of customers. Even though our data set sizes are small,
when using hashed values, the range of the hashes produced can be large.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dbldatagen</span> <span class="k">as</span> <span class="nn">dg</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>

<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.shuffle.partitions&quot;</span><span class="p">,</span> <span class="n">shuffle_partitions_requested</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.execution.arrow.pyspark.enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.execution.arrow.maxRecordsPerBatch&quot;</span><span class="p">,</span> <span class="mi">20000</span><span class="p">)</span>

<span class="n">UNIQUE_CUSTOMERS</span> <span class="o">=</span> <span class="mi">50000</span>
<span class="n">CUSTOMER_MIN_VALUE</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">DEVICE_MIN_VALUE</span> <span class="o">=</span> <span class="mi">1000000000</span>
<span class="n">SUBSCRIBER_NUM_MIN_VALUE</span> <span class="o">=</span> <span class="mi">1000000000</span>

<span class="n">spark</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">clearCache</span><span class="p">()</span>  <span class="c1"># clear cache so that if we run multiple times to check</span>
                            <span class="c1"># performance, we&#39;re not relying on cache</span>
<span class="n">shuffle_partitions_requested</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">partitions_requested</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">data_rows</span> <span class="o">=</span> <span class="n">UNIQUE_CUSTOMERS</span>

<span class="n">customer_dataspec</span> <span class="o">=</span> <span class="p">(</span><span class="n">dg</span><span class="o">.</span><span class="n">DataGenerator</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">data_rows</span><span class="p">,</span> <span class="n">partitions</span><span class="o">=</span><span class="n">partitions_requested</span><span class="p">)</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;customer_id&quot;</span><span class="p">,</span><span class="s2">&quot;decimal(10)&quot;</span><span class="p">,</span> <span class="n">minValue</span><span class="o">=</span><span class="n">CUSTOMER_MIN_VALUE</span><span class="p">,</span>
                        <span class="n">uniqueValues</span><span class="o">=</span><span class="n">UNIQUE_CUSTOMERS</span><span class="p">)</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;customer_name&quot;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">w </span><span class="se">\\</span><span class="s2">w|</span><span class="se">\\</span><span class="s2">w a. </span><span class="se">\\</span><span class="s2">w&quot;</span><span class="p">)</span>

            <span class="c1"># use the following for a simple sequence</span>
            <span class="c1">#.withColumn(&quot;device_id&quot;,&quot;decimal(10)&quot;, minValue=DEVICE_MIN_VALUE,</span>
            <span class="c1">#              uniqueValues=UNIQUE_CUSTOMERS)</span>

            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;device_id&quot;</span><span class="p">,</span><span class="s2">&quot;decimal(10)&quot;</span><span class="p">,</span>  <span class="n">minValue</span><span class="o">=</span><span class="n">DEVICE_MIN_VALUE</span><span class="p">,</span>
                        <span class="n">baseColumn</span><span class="o">=</span><span class="s2">&quot;customer_id&quot;</span><span class="p">,</span> <span class="n">baseColumnType</span><span class="o">=</span><span class="s2">&quot;hash&quot;</span><span class="p">)</span>

            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;phone_number&quot;</span><span class="p">,</span><span class="s2">&quot;decimal(10)&quot;</span><span class="p">,</span>  <span class="n">minValue</span><span class="o">=</span><span class="n">SUBSCRIBER_NUM_MIN_VALUE</span><span class="p">,</span>
                        <span class="n">baseColumn</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;customer_id&quot;</span><span class="p">,</span> <span class="s2">&quot;customer_name&quot;</span><span class="p">],</span> <span class="n">baseColumnType</span><span class="o">=</span><span class="s2">&quot;hash&quot;</span><span class="p">)</span>

            <span class="c1"># for email, we&#39;ll just use the formatted phone number</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>  <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;subscriber_</span><span class="si">%s</span><span class="s2">@myoperator.com&quot;</span><span class="p">,</span>
                        <span class="n">baseColumn</span><span class="o">=</span><span class="s2">&quot;phone_number&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">minValue</span><span class="o">=</span><span class="n">PLAN_MIN_VALUE</span><span class="p">,</span> <span class="n">uniqueValues</span><span class="o">=</span><span class="n">UNIQUE_PLANS</span><span class="p">,</span>
                        <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>

<span class="n">df_customers</span> <span class="o">=</span> <span class="p">(</span><span class="n">customer_dataspec</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
                <span class="o">.</span><span class="n">dropDuplicates</span><span class="p">([</span><span class="s2">&quot;device_id&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">dropDuplicates</span><span class="p">([</span><span class="s2">&quot;phone_number&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;customer_id&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">cache</span><span class="p">()</span>
               <span class="p">)</span>

<span class="n">effective_customers</span> <span class="o">=</span> <span class="n">df_customers</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">stripMargin</span><span class="p">(</span>
  <span class="sa">f</span><span class="s2">&quot;&quot;&quot;revised customers : </span><span class="si">{</span><span class="n">df_customers</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">   |   unique customers: </span><span class="si">{</span><span class="n">df_customers</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">countDistinct</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">   |   unique device ids: </span><span class="si">{</span><span class="n">df_customers</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">countDistinct</span><span class="p">(</span><span class="s1">&#39;device_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">   |   unique phone numbers: </span><span class="si">{</span><span class="n">df_customers</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">countDistinct</span><span class="p">(</span><span class="s1">&#39;phone_number&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
     <span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">df_customers</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="now-let-s-model-our-device-events">
<h3>Now let’s model our device events<a class="headerlink" href="#now-let-s-model-our-device-events" title="Permalink to this heading"></a></h3>
<p>Generating <cite>master-detail</cite> style data is one of the key challenges in data generation for join ready data.</p>
<p>What do we mean by <cite>master-detail</cite>?</p>
<p>This is where the goal is to model data that consists of large grained entities, that are in turn
comprised of smaller items. For example invoices and their respective line items follow this pattern.</p>
<p>IOT data has similar characteristics. Usually you have a series of devices that generate time series style
events from their respective systems and subsystems - each data row being an observation of
some measure from some subsystem at a point in time.</p>
<p>Telephony billing activity has characteristics of both IOT data and master detail data.</p>
<p>For the telephony events, we want to ensure that on average <cite>n</cite> events occur per device per day and
that text and internet browsing is more frequent than phone calls.</p>
<p>A simple approach is simply to multiply the
<cite>number of customers</cite> by <cite>number of days in data set</cite>  by <cite>average events per day</cite></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dbldatagen</span> <span class="k">as</span> <span class="nn">dg</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>

<span class="n">AVG_EVENTS_PER_CUSTOMER</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">spark</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">clearCache</span><span class="p">()</span>
<span class="n">shuffle_partitions_requested</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">partitions_requested</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">NUM_DAYS</span><span class="o">=</span><span class="mi">31</span>
<span class="n">MB_100</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span>
<span class="n">K_1</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">data_rows</span> <span class="o">=</span> <span class="n">AVG_EVENTS_PER_CUSTOMER</span> <span class="o">*</span> <span class="n">UNIQUE_CUSTOMERS</span> <span class="o">*</span> <span class="n">NUM_DAYS</span>

<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.shuffle.partitions&quot;</span><span class="p">,</span> <span class="n">shuffle_partitions_requested</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.execution.arrow.pyspark.enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.execution.arrow.maxRecordsPerBatch&quot;</span><span class="p">,</span> <span class="mi">20000</span><span class="p">)</span>


<span class="c1"># use random seed method of &#39;hash_fieldname&#39; for better spread - default in later builds</span>
<span class="n">events_dataspec</span> <span class="o">=</span> <span class="p">(</span><span class="n">dg</span><span class="o">.</span><span class="n">DataGenerator</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">data_rows</span><span class="p">,</span> <span class="n">partitions</span><span class="o">=</span><span class="n">partitions_requested</span><span class="p">,</span>
                   <span class="n">randomSeed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">randomSeedMethod</span><span class="o">=</span><span class="s2">&quot;hash_fieldname&quot;</span><span class="p">)</span>
             <span class="c1"># use same logic as per customers dataset to ensure matching keys</span>
             <span class="c1"># but make them random</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;device_id_base&quot;</span><span class="p">,</span><span class="s2">&quot;decimal(10)&quot;</span><span class="p">,</span> <span class="n">minValue</span><span class="o">=</span><span class="n">CUSTOMER_MIN_VALUE</span><span class="p">,</span>
                        <span class="n">uniqueValues</span><span class="o">=</span><span class="n">UNIQUE_CUSTOMERS</span><span class="p">,</span>
                        <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">omit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;device_id&quot;</span><span class="p">,</span><span class="s2">&quot;decimal(10)&quot;</span><span class="p">,</span>  <span class="n">minValue</span><span class="o">=</span><span class="n">DEVICE_MIN_VALUE</span><span class="p">,</span>
                        <span class="n">baseColumn</span><span class="o">=</span><span class="s2">&quot;device_id_base&quot;</span><span class="p">,</span> <span class="n">baseColumnType</span><span class="o">=</span><span class="s2">&quot;hash&quot;</span><span class="p">)</span>

            <span class="c1"># use specific random seed to get better spread of values</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">,</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
                        <span class="n">values</span><span class="o">=</span><span class="p">[</span> <span class="s2">&quot;sms&quot;</span><span class="p">,</span> <span class="s2">&quot;internet&quot;</span><span class="p">,</span> <span class="s2">&quot;local call&quot;</span><span class="p">,</span> <span class="s2">&quot;ld call&quot;</span><span class="p">,</span> <span class="s2">&quot;intl call&quot;</span> <span class="p">],</span>
                        <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span> <span class="p">],</span> <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># use Gamma distribution for skew towards short calls</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;base_minutes&quot;</span><span class="p">,</span><span class="s2">&quot;decimal(7,2)&quot;</span><span class="p">,</span>
                        <span class="n">minValue</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">maxValue</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                        <span class="n">distribution</span><span class="o">=</span><span class="n">dg</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">2.0</span><span class="p">),</span>
                        <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">omit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># use Gamma distribution for skew towards short transfers</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;base_bytes_transferred&quot;</span><span class="p">,</span><span class="s2">&quot;decimal(12)&quot;</span><span class="p">,</span>
                        <span class="n">minValue</span><span class="o">=</span><span class="n">K_1</span><span class="p">,</span> <span class="n">maxValue</span><span class="o">=</span><span class="n">MB_100</span><span class="p">,</span>
                        <span class="n">distribution</span><span class="o">=</span><span class="n">dg</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">2.0</span><span class="p">),</span>
                        <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">omit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;minutes&quot;</span><span class="p">,</span> <span class="s2">&quot;decimal(7,2)&quot;</span><span class="p">,</span>
                        <span class="n">baseColumn</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;event_type&quot;</span><span class="p">,</span> <span class="s2">&quot;base_minutes&quot;</span><span class="p">],</span>
                        <span class="n">expr</span><span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                              case when event_type in (&quot;local call&quot;, &quot;ld call&quot;, &quot;intl call&quot;)</span>
<span class="s2">                                  then base_minutes</span>
<span class="s2">                                  else 0</span>
<span class="s2">                              end</span>
<span class="s2">                               &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;bytes_transferred&quot;</span><span class="p">,</span> <span class="s2">&quot;decimal(12)&quot;</span><span class="p">,</span>
                        <span class="n">baseColumn</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;event_type&quot;</span><span class="p">,</span> <span class="s2">&quot;base_bytes_transferred&quot;</span><span class="p">],</span>
                        <span class="n">expr</span><span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                              case when event_type = &quot;internet&quot;</span>
<span class="s2">                                   then base_bytes_transferred</span>
<span class="s2">                                   else 0</span>
<span class="s2">                              end</span>
<span class="s2">                               &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;event_ts&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span>
                         <span class="n">data_range</span><span class="o">=</span><span class="n">dg</span><span class="o">.</span><span class="n">DateRange</span><span class="p">(</span><span class="s2">&quot;2020-07-01 00:00:00&quot;</span><span class="p">,</span>
                                                 <span class="s2">&quot;2020-07-31 11:59:59&quot;</span><span class="p">,</span>
                                                 <span class="s2">&quot;seconds=1&quot;</span><span class="p">),</span>
                        <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="p">)</span>

<span class="n">df_events</span> <span class="o">=</span> <span class="n">events_dataspec</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

<span class="n">display</span><span class="p">(</span><span class="n">df_events</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="now-let-s-compute-the-invoices">
<h2>Now let’s compute the invoices<a class="headerlink" href="#now-let-s-compute-the-invoices" title="Permalink to this heading"></a></h2>
<p>Let’s compute the customers and associated plans</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dbldatagen</span> <span class="k">as</span> <span class="nn">dg</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.types</span> <span class="k">as</span> <span class="nn">T</span>

<span class="n">df_customer_pricing</span> <span class="o">=</span> <span class="n">df_customers</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_plans</span><span class="p">,</span> <span class="n">df_plans</span><span class="o">.</span><span class="n">plan_id</span> <span class="o">==</span> <span class="n">df_customers</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">df_customer_pricing</span><span class="p">)</span>
</pre></div>
</div>
<p>let’s compute our summary information</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dbldatagen</span> <span class="k">as</span> <span class="nn">dg</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.types</span> <span class="k">as</span> <span class="nn">T</span>


<span class="c1"># lets compute the summary minutes messages and bytes transferred</span>
<span class="n">df_enriched_events</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_events</span>
                      <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;message_count&quot;</span><span class="p">,</span>
                                  <span class="n">F</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;case</span>
<span class="s2">                                               when event_type=&#39;sms&#39; then 1</span>
<span class="s2">                                                                     else 0 end&quot;&quot;&quot;</span><span class="p">))</span>
                      <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;ld_minutes&quot;</span><span class="p">,</span>
                                  <span class="n">F</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;case</span>
<span class="s2">                                               when event_type=&#39;ld call&#39;</span>
<span class="s2">                                               then cast(ceil(minutes) as decimal(18,3))</span>
<span class="s2">                                               else 0.0 end&quot;&quot;&quot;</span><span class="p">))</span>
                      <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;local_minutes&quot;</span><span class="p">,</span>
                                  <span class="n">F</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;case when event_type=&#39;local call&#39;</span>
<span class="s2">                                                 then cast(ceil(minutes) as decimal(18,3))</span>
<span class="s2">                                                 else 0.0 end&quot;&quot;&quot;</span><span class="p">))</span>
                      <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;intl_minutes&quot;</span><span class="p">,</span>
                                  <span class="n">F</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;case when event_type=&#39;intl call&#39;</span>
<span class="s2">                                            then cast(ceil(minutes) as decimal(18,3))</span>
<span class="s2">                                            else 0.0 end&quot;&quot;&quot;</span><span class="p">))</span>
                     <span class="p">)</span>

<span class="n">df_enriched_events</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;telephony_events&quot;</span><span class="p">)</span>

<span class="n">df_summary</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select device_id,</span>
<span class="s2">                                 round(sum(bytes_transferred) / 1000000.0, 3) as total_mb,</span>
<span class="s2">                                 sum(message_count) as total_messages,</span>
<span class="s2">                                 sum(ld_minutes) as total_ld_minutes,</span>
<span class="s2">                                 sum(local_minutes) as total_local_minutes,</span>
<span class="s2">                                 sum(intl_minutes) as total_intl_minutes,</span>
<span class="s2">                                 count(device_id) as event_count</span>
<span class="s2">                                 from telephony_events</span>
<span class="s2">                                 group by device_id</span>

<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">df_summary</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;event_summary&quot;</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">df_summary</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;event_count &gt; 0&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>now let’s compute the invoices</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_customer_summary</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">df_customer_pricing</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_summary</span><span class="p">,</span>
                                <span class="n">df_customer_pricing</span><span class="o">.</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">df_summary</span><span class="o">.</span><span class="n">device_id</span> <span class="p">)</span>
                       <span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;customer_summary&quot;</span><span class="p">))</span>

<span class="n">df_invoices</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                     select *,</span>
<span class="s2">                        internet_cost + sms_cost + ld_cost + local_cost + intl_cost</span>
<span class="s2">                          as total_invoice</span>
<span class="s2">                        from</span>
<span class="s2">                          (select customer_id, customer_name,</span>
<span class="s2">                                  phone_number, email, plan_name,</span>
<span class="s2">                                  cast(round(total_mb * cost_per_mb, 2) as decimal(18,3))</span>
<span class="s2">                                      as internet_cost,</span>
<span class="s2">                                  cast(round(total_ld_minutes * ld_cost_per_minute, 2)</span>
<span class="s2">                                       as decimal(18,2))</span>
<span class="s2">                                    as ld_cost,</span>
<span class="s2">                                  cast(round(total_local_minutes * cost_per_minute, 2)</span>
<span class="s2">                                       as decimal(18,2))</span>
<span class="s2">                                    as local_cost,</span>
<span class="s2">                                  cast(round(total_intl_minutes * intl_cost_per_minute, 2)</span>
<span class="s2">                                       as decimal(18,2))</span>
<span class="s2">                                    as intl_cost,</span>
<span class="s2">                                  cast(round(total_messages * cost_per_message, 2)</span>
<span class="s2">                                       as decimal(18,2))</span>
<span class="s2">                                    as sms_cost</span>
<span class="s2">                           from customer_summary)</span>

<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">df_invoices</span><span class="p">)</span>
</pre></div>
</div>
<p>You can confirm that we have invoices for all customers by issuing a <code class="docutils literal notranslate"><span class="pre">count</span></code> on the invoices data set.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df_invoices</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="generating_cdc_data.html" class="btn btn-neutral float-left" title="Generating Change Data Capture Data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="extending_text_generation.html" class="btn btn-neutral float-right" title="Extending Text Generation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Databricks Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>