<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dbldatagen.text_generator_plugins &mdash; Databricks Labs Data Generator 0.3.6post1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/tdg.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Databricks Labs Data Generator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../APIDOCS.html">Get Started Here</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation_notes.html">Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generating_column_data.html">Generating column data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DATARANGES.html">Using data ranges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../textdata.html">Generating text data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DISTRIBUTIONS.html">Using data distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../options_and_features.html">Options for column specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../repeatable_data_generation.html">Repeatable Data Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../repeatable_data_generation.html#revisiting-the-iot-data-example">Revisiting the IOT data example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../using_streaming_data.html">Using streaming data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generating_json_data.html">Generating JSON and structured column data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generating_from_existing_data.html">Generating synthetic data from existing data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generating_cdc_data.html">Generating Change Data Capture (CDC) data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../multi_table_data.html">Using multiple tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extending_text_generation.html">Extending text generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../using_delta_live_tables.html">Use with Delta Live Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting data generation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../relnotes/quickindex.html">Quick API index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/api/modules.html">The dbldatagen package API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../relnotes/CONTRIBUTING.html">Contributing to the Databricks Labs Data Generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relnotes/CONTRIBUTING.html#building-the-code">Building the code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relnotes/CONTRIBUTING.html#testing">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relnotes/CONTRIBUTING.html#using-the-databricks-labs-data-generator">Using the Databricks Labs data generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relnotes/CONTRIBUTING.html#coding-style">Coding Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relnotes/CHANGELOG.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relnotes/requirements.html">Build requirements</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">License</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Databricks Labs Data Generator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dbldatagen.text_generator_plugins</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dbldatagen.text_generator_plugins</h1><div class="highlight"><pre>
<span></span><span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file defines the text generator plugin class `PyfuncText`</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">.text_generators</span> <span class="kn">import</span> <span class="n">TextGenerator</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">DataGenError</span>


<div class="viewcode-block" id="PyfuncText"><a class="viewcode-back" href="../../reference/api/dbldatagen.text_generator_plugins.html#dbldatagen.text_generator_plugins.PyfuncText">[docs]</a><span class="k">class</span> <span class="nc">PyfuncText</span><span class="p">(</span><span class="n">TextGenerator</span><span class="p">):</span>  <span class="c1"># lgtm [py/missing-equals]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Text generator that supports generating text from arbitrary Python function</span>

<span class="sd">    :param fn: function to call to generate text.</span>
<span class="sd">    :param init: function to call to initialize context</span>
<span class="sd">    :param initPerBatch: if init per batch is set to True, initialization of context is performed on every Pandas udf</span>
<span class="sd">                         call. Default is False.</span>
<span class="sd">    :param name: String representing name of text generator when converted to string via ``repr`` or ``str``</span>

<span class="sd">    The two functions define the plugin model</span>

<span class="sd">    The first function, ``fn`` is called whenever text should be generated for a single column of a single row</span>

<span class="sd">    It is called with the signature ``fn(context, value)`` unless a root property is set, in which the signature is</span>
<span class="sd">    ``fn(rootProperty)`` with rootProperty having the value of the root property of the context.</span>

<span class="sd">    Context is the stored context containing instances of random number generators, 3rd party</span>
<span class="sd">    client library objects etc.</span>

<span class="sd">    The ``initFn`` is called to initialize the function call context. The plugin code can store arbitrary properties</span>
<span class="sd">    in the context following normal Python object rules.</span>

<span class="sd">    The context is initialized with the property `textGenerator` prior to being initialized which is a reference to the</span>
<span class="sd">    enclosing text generator.</span>

<span class="sd">    .. note::</span>
<span class="sd">              There are no expectations of repeatability of data generation when using external code</span>
<span class="sd">              or external libraries to generate text.</span>

<span class="sd">              However, custom code can call the base class method to get a Numpy random</span>
<span class="sd">              number generator instance. This will have been seeded using the ``dbldatagen``</span>
<span class="sd">              random number seed if one was specified, so random numbers generated from this will be repeatable.</span>

<span class="sd">              The custom code may call the property ``randomSeed`` on the text generator object to get the random seed</span>
<span class="sd">              which may be used to seed library specific initialization.</span>

<span class="sd">              This random seed property may have the values ``None`` or ``-1`` which should be treated as meaning dont</span>
<span class="sd">              use a random seed.</span>

<span class="sd">              The code does not guarantee thread or cross process safety. If a new instance of the random number</span>
<span class="sd">              generator is needed, you may call the base class method with the argument `forceNewInstance` set to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">_FnCallContext</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; inner class to support storage of context between calls</span>

<span class="sd">            initial instances of random number generators, clients for services etc here during execution</span>
<span class="sd">            of the `initFn` calls</span>

<span class="sd">            :param txtGen: - reference to outer PyfnText object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txtGen</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">textGenerator</span> <span class="o">=</span> <span class="n">txtGen</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initPerBatch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rootProperty</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">callable</span><span class="p">(</span><span class="n">fn</span><span class="p">),</span> <span class="s2">&quot;Function must be provided wiith signature fn(context, oldValue)&quot;</span>
        <span class="k">assert</span> <span class="n">init</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">callable</span><span class="p">(</span><span class="n">init</span><span class="p">),</span> <span class="s2">&quot;Init function must be a callable function or lambda if passed&quot;</span>

        <span class="c1"># if root property is provided, root property will be passed to generate text function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rootProperty</span> <span class="o">=</span> <span class="n">rootProperty</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pyFn</span> <span class="o">=</span> <span class="n">fn</span>  <span class="c1"># generate text function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initFn</span> <span class="o">=</span> <span class="n">init</span>  <span class="c1"># context initialization function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># context used to hold library root object and other properties</span>

        <span class="c1"># if init per batch is True, initialization of context will be per UDF call</span>
        <span class="k">assert</span> <span class="n">initPerBatch</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="s2">&quot;initPerBatch must evaluate to boolean True or False&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initPerBatch</span> <span class="o">=</span> <span class="n">initPerBatch</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;PyfuncText&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Get string representation of object</span>
<span class="sd">            ``name`` property is used to provide user friendly name for text generator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pyFn</span><span class="p">)</span><span class="si">}</span><span class="s2">, init=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_initFn</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="nf">_getContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceNewInstance</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Get the context for plugin function calls</span>

<span class="sd">        :param forceNewInstance: if True, forces each call to create a new context</span>
<span class="sd">        :return: existing or newly created context.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">forceNewInstance</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">PyfuncText</span><span class="o">.</span><span class="n">_FnCallContext</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="c1"># init context using context creator if any provided</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initFn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_initFn</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

            <span class="c1"># save context for later use unless forceNewInstance is set</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">forceNewInstance</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">context</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">context</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span>

<div class="viewcode-block" id="PyfuncText.pandasGenerateText"><a class="viewcode-back" href="../../reference/api/dbldatagen.text_generator_plugins.html#dbldatagen.text_generator_plugins.PyfuncText.pandasGenerateText">[docs]</a>    <span class="k">def</span> <span class="nf">pandasGenerateText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Called to generate text via Pandas UDF mechanism</span>

<span class="sd">        :param v: base value of column as Pandas Series</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># save object properties in local vars to avoid overhead of object dereferences</span>
        <span class="c1"># on every call</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initPerBatch</span><span class="p">)</span>
        <span class="n">evalFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyFn</span>
        <span class="n">rootProperty</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rootProperty</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rootProperty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># define functions to call with context and with root property</span>
        <span class="k">def</span> <span class="nf">_valueFromFn</span><span class="p">(</span><span class="n">originalValue</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">evalFn</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">originalValue</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_valueFromFnWithRoot</span><span class="p">(</span><span class="n">originalValue</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">evalFn</span><span class="p">(</span><span class="n">rootProperty</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rootProperty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_valueFromFnWithRoot</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_valueFromFn</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div></div>


<div class="viewcode-block" id="PyfuncTextFactory"><a class="viewcode-back" href="../../reference/api/dbldatagen.text_generator_plugins.html#dbldatagen.text_generator_plugins.PyfuncTextFactory">[docs]</a><span class="k">class</span> <span class="nc">PyfuncTextFactory</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;PyfuncTextFactory applies syntactic wrapping around creation of PyfuncText objects</span>

<span class="sd">    :param name: name of generated object (when converted to string via ``str``)</span>

<span class="sd">    It allows the use of the following constructs:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">       # initialization (for Faker for example)</span>

<span class="sd">       # setup use of Faker</span>
<span class="sd">       def initFaker(ctx):</span>
<span class="sd">         ctx.faker = Faker(locale=&quot;en_US&quot;)</span>
<span class="sd">         ctx.faker.add_provider(internet)</span>

<span class="sd">       FakerText = (PyfuncTextFactory(name=&quot;FakerText&quot;)</span>
<span class="sd">                   .withInit(initFaker)        # determines how context should be initialized</span>
<span class="sd">                   .withRootProperty(&quot;faker&quot;)  # determines what context property is passed to fn</span>
<span class="sd">                   )</span>

<span class="sd">       # later use ...</span>
<span class="sd">       .withColumn(&quot;fake_name&quot;, text=FakerText(&quot;sentence&quot;, ext_word_list=my_word_list) )</span>
<span class="sd">       .withColumn(&quot;fake_sentence&quot;, text=FakerText(&quot;sentence&quot;, ext_word_list=my_word_list) )</span>

<span class="sd">       # translates to generation of lambda function with keyword arguments</span>
<span class="sd">       # or without as needed</span>
<span class="sd">       .withColumn(&quot;fake_name&quot;,</span>
<span class="sd">                   text=FakerText( (lambda faker: faker.name( )),</span>
<span class="sd">                                   init=initFaker,</span>
<span class="sd">                                   rootProperty=&quot;faker&quot;,</span>
<span class="sd">                                   name=&quot;FakerText&quot;))</span>
<span class="sd">       .withColumn(&quot;fake_sentence&quot;,</span>
<span class="sd">                   text=FakerText( (lambda faker:</span>
<span class="sd">                                       faker.sentence( **{ &quot;ext_word_list&quot; : my_word_list} )),</span>
<span class="sd">                                   init=initFaker,</span>
<span class="sd">                                   rootProperty=&quot;faker&quot;,</span>
<span class="sd">                                   name=&quot;FakerText&quot;))</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param name: name of generated object (when converted to string via ``str``)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initFn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rootProperty</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;PyfuncText&quot;</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initPerBatch</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="PyfuncTextFactory.withInit"><a class="viewcode-back" href="../../reference/api/dbldatagen.text_generator_plugins.html#dbldatagen.text_generator_plugins.PyfuncTextFactory.withInit">[docs]</a>    <span class="k">def</span> <span class="nf">withInit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Specifies context initialization function</span>

<span class="sd">            :param fn: function pointer or lambda function for initialization</span>
<span class="sd">                       signature should ``initFunction(context)``</span>

<span class="sd">            .. note::</span>
<span class="sd">               This variation initializes the context once per worker process per text generator</span>
<span class="sd">               instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initFn</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="PyfuncTextFactory.withInitPerBatch"><a class="viewcode-back" href="../../reference/api/dbldatagen.text_generator_plugins.html#dbldatagen.text_generator_plugins.PyfuncTextFactory.withInitPerBatch">[docs]</a>    <span class="k">def</span> <span class="nf">withInitPerBatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Specifies context initialization function</span>

<span class="sd">            :param fn: function pointer or lambda function for initialization</span>
<span class="sd">                       signature should ``initFunction(context)``</span>

<span class="sd">            .. note::</span>
<span class="sd">               This variation initializes the context once per internal pandas UDF call.</span>
<span class="sd">               The UDF call will be called once per 10,000 rows if system is configured using defaults.</span>
<span class="sd">               Setting the pandas batch size as an argument to the DataSpec creation will change the default</span>
<span class="sd">               batch size.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initPerBatch</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">withInit</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span></div>

<div class="viewcode-block" id="PyfuncTextFactory.withRootProperty"><a class="viewcode-back" href="../../reference/api/dbldatagen.text_generator_plugins.html#dbldatagen.text_generator_plugins.PyfuncTextFactory.withRootProperty">[docs]</a>    <span class="k">def</span> <span class="nf">withRootProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; If called, specifies the property of the context to be passed to the text generation function.</span>
<span class="sd">            If not called, the context object itself will be passed to the text generation function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rootProperty</span> <span class="o">=</span> <span class="n">prop</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evalFn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">isProperty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Internal function call mechanism that implements the syntax expansion</span>

<span class="sd">        :param evalFn: text generation function or lambda</span>
<span class="sd">        :param args: optional args to be passed by position</span>
<span class="sd">        :param kwargs: optional keyword args following Python keyword passing mechanism</span>
<span class="sd">        :param isProperty: if true, interpret evalFn as string name of property, not a function or method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">evalFn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">evalFn</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">callable</span><span class="p">(</span><span class="n">evalFn</span><span class="p">)),</span> <span class="s2">&quot;Function must be provided&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">evalFn</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rootProperty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rootProperty</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> \
                <span class="s2">&quot;string named functions can only be used on text generators with root property&quot;</span>
            <span class="n">fnName</span> <span class="o">=</span> <span class="n">evalFn</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># generate lambda with both kwargs and args</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">isProperty</span><span class="p">,</span> <span class="s2">&quot;isProperty cannot be true if using arguments&quot;</span>
                <span class="n">evalFn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">root</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">fnName</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># generate lambda with positional args</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">isProperty</span><span class="p">,</span> <span class="s2">&quot;isProperty cannot be true if using arguments&quot;</span>
                <span class="n">evalFn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">root</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">fnName</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># generate lambda with keyword args</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">isProperty</span><span class="p">,</span> <span class="s2">&quot;isProperty cannot be true if using arguments&quot;</span>
                <span class="n">evalFn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">root</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">fnName</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">isProperty</span><span class="p">:</span>
                <span class="c1"># generate lambda with property access, not method call</span>
                <span class="n">evalFn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">root</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">fnName</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># generate lambda with no args</span>
                <span class="n">evalFn</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">root</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">fnName</span><span class="p">)())</span>

        <span class="c1"># returns the actual PyfuncText text generator object.</span>
        <span class="c1"># Note all syntax expansion is performed once only</span>
        <span class="k">return</span> <span class="n">PyfuncText</span><span class="p">(</span><span class="n">evalFn</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_initFn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">rootProperty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rootProperty</span><span class="p">)</span></div>


<div class="viewcode-block" id="FakerTextFactory"><a class="viewcode-back" href="../../reference/api/dbldatagen.text_generator_plugins.html#dbldatagen.text_generator_plugins.FakerTextFactory">[docs]</a><span class="k">class</span> <span class="nc">FakerTextFactory</span><span class="p">(</span><span class="n">PyfuncTextFactory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Factory object for Faker text generator flavored ``PyfuncText`` objects</span>

<span class="sd">    :param locale: list of locales. If empty, defaults to ``en-US``</span>
<span class="sd">    :param providers: list of providers</span>
<span class="sd">    :param name: name of generated objects. Defaults to ``FakerText``</span>
<span class="sd">    :param lib: library import name of Faker library. If none passed, uses ``faker``</span>
<span class="sd">    :param rootClass: name of root object class If none passed, uses ``Faker``</span>

<span class="sd">    ..note ::</span>
<span class="sd">       Both the library name and root object class can be overridden - this is primarily for internal testing purposes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_FAKER_LIB</span> <span class="o">=</span> <span class="s2">&quot;faker&quot;</span>

    <span class="n">_defaultFakerTextFactory</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">providers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;FakerText&quot;</span><span class="p">,</span> <span class="n">lib</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">rootClass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># set up the logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;FakerTextFactory&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

        <span class="c1"># setup Faker library to use</span>
        <span class="k">if</span> <span class="n">lib</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FAKER_LIB</span>

        <span class="c1"># allow overriding the root object class for test purposes</span>
        <span class="k">if</span> <span class="n">rootClass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rootObjectClass</span> <span class="o">=</span> <span class="s2">&quot;Faker&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rootObjectClass</span> <span class="o">=</span> <span class="n">rootClass</span>

        <span class="c1"># load the library</span>
        <span class="n">fakerModule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadLibrary</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>

        <span class="c1"># make the initialization function</span>
        <span class="n">initFn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mkInitFn</span><span class="p">(</span><span class="n">fakerModule</span><span class="p">,</span> <span class="n">locale</span><span class="p">,</span> <span class="n">providers</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">withInit</span><span class="p">(</span><span class="n">initFn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">withRootProperty</span><span class="p">(</span><span class="s2">&quot;faker&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_getDefaultFactory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lib</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rootClass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Class method to get default faker text factory</span>

<span class="sd">           Not intended for general use</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_defaultFakerTextFactory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_defaultFakerTextFactory</span> <span class="o">=</span> <span class="n">FakerTextFactory</span><span class="p">(</span><span class="n">lib</span><span class="o">=</span><span class="n">lib</span><span class="p">,</span> <span class="n">rootClass</span><span class="o">=</span><span class="n">rootClass</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_defaultFakerTextFactory</span>

    <span class="k">def</span> <span class="nf">_mkInitFn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">libModule</span><span class="p">,</span> <span class="n">locale</span><span class="p">,</span> <span class="n">providers</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Make Faker initialization function</span>

<span class="sd">        :param locale: locale string or list of locale strings</span>
<span class="sd">        :param providers: providers to load</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">libModule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;must have a valid loaded Faker library module&quot;</span>

        <span class="n">fakerClass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">libModule</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rootObjectClass</span><span class="p">)</span>

        <span class="c1"># define the initialization function for Faker</span>
        <span class="k">def</span> <span class="nf">fakerInitFn</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">faker</span> <span class="o">=</span> <span class="n">fakerClass</span><span class="p">(</span><span class="n">locale</span><span class="o">=</span><span class="n">locale</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">faker</span> <span class="o">=</span> <span class="n">fakerClass</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">providers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="n">providers</span><span class="p">:</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">faker</span><span class="o">.</span><span class="n">add_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fakerInitFn</span>

    <span class="k">def</span> <span class="nf">_loadLibrary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lib</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Load faker library if not already loaded</span>

<span class="sd">        :param lib: library name of Faker library. If none passed, uses ``faker``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># load library</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span> <span class="sa">f</span><span class="s2">&quot;Library ``</span><span class="si">{</span><span class="n">lib</span><span class="si">}</span><span class="s2">`` must be a valid library name&quot;</span>

                <span class="k">if</span> <span class="n">lib</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
                    <span class="k">return</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">lib</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fakerModule</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
                    <span class="nb">globals</span><span class="p">()[</span><span class="n">lib</span><span class="p">]</span> <span class="o">=</span> <span class="n">fakerModule</span>
                    <span class="k">return</span> <span class="n">fakerModule</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># pylint: disable=raise-missing-from</span>
            <span class="k">raise</span> <span class="n">DataGenError</span><span class="p">(</span><span class="s2">&quot;Could not load or initialize Faker library&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span></div>


<div class="viewcode-block" id="fakerText"><a class="viewcode-back" href="../../reference/api/dbldatagen.text_generator_plugins.html#dbldatagen.text_generator_plugins.fakerText">[docs]</a><span class="k">def</span> <span class="nf">fakerText</span><span class="p">(</span><span class="n">mname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">_lib</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_rootClass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate faker text generator object using default FakerTextFactory</span>
<span class="sd">       instance</span>

<span class="sd">       :param mname: method name to invoke</span>
<span class="sd">       :param args: positional args to be passed to underlying Faker instance</span>
<span class="sd">       :param _lib: internal only param - library to load</span>
<span class="sd">       :param _rootClass: internal only param - root class to create</span>
<span class="sd">       </span>
<span class="sd">       :returns : instance of PyfuncText for use with Faker</span>

<span class="sd">       ``fakerText(&quot;sentence&quot;)`` is same as ``FakerTextFactory()(&quot;sentence&quot;)``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">defaultFactory</span> <span class="o">=</span> <span class="n">FakerTextFactory</span><span class="o">.</span><span class="n">_getDefaultFactory</span><span class="p">(</span><span class="n">lib</span><span class="o">=</span><span class="n">_lib</span><span class="p">,</span>
                                                         <span class="n">rootClass</span><span class="o">=</span><span class="n">_rootClass</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">defaultFactory</span><span class="p">(</span><span class="n">mname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># pylint: disable=not-callable</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Databricks Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>